{% extends "base.html" %}
{% load static %}

{% block title %}Consultation â€” {{ appointment.patient.full_name }}{% endblock %}

{% block extra_css %}
<style>
.info-card {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    height: 100%;
}
.section-title {
    font-weight: 600;
    margin-bottom: 12px;
    color: #0d6efd;
    display: flex;
    align-items: center;
    gap: 8px;
}
.notes-card textarea {
    min-height: 110px;
    resize: none;
}
.badge-soft {
    background: #eef4ff;
    color: #0d6efd;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
}
@media (min-width: 992px) {
    .sticky-panel {
        position: sticky;
        top: 100px;
    }
}
.info-label { color: #222; font-weight: 600; }
.info-value { color: #444; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-4">

        <!-- LEFT: Patient Info -->
        <div class="col-lg-3">
            <div class="info-card sticky-panel">
                <h6 class="section-title">ðŸ‘¤ Patient Info</h6>
                <p><b>Name:</b> {{ appointment.patient.full_name }}</p>
               <p><b>Age:</b> {{ appointment.patient.age }} years</p>
                <p><b>Gender:</b> {{ appointment.patient.gender }}</p>
                <p><b>Phone:</b> {{ appointment.patient.phone|default:"â€”" }}</p>
                <p><b>City:</b> {{ appointment.patient.city|default:"â€”" }}</p>
                <hr>
                <small class="text-muted">
                    {{ appointment.reason|default:"No symptoms specified" }}
                </small>
            </div>
        </div>

        <!-- CENTER: Medical Notes -->
        <div class="col-lg-6">
            <div class="info-card notes-card">
                <h5 class="section-title">ðŸ©º Medical Notes</h5>

                <form id="notesForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="fw-semibold">Notes</label>
                        <textarea name="notes" class="form-control" required>
{% if appointment.medical_note %}{{ appointment.medical_note.notes }}{% endif %}
                        </textarea>
                    </div>

                    <div class="mb-3">
                        <label class="fw-semibold">Prescription</label>
                        <textarea name="prescription" class="form-control">
{% if appointment.medical_note %}{{ appointment.medical_note.prescription }}{% endif %}
                        </textarea>
                    </div>

                    <div class="mb-3">
                        <label class="fw-semibold">Follow Up</label>
                        <textarea name="follow_up" class="form-control">
{% if appointment.medical_note %}{{ appointment.medical_note.follow_up }}{% endif %}
                        </textarea>
                    </div>

                    <button class="btn btn-success px-4">Save Notes</button>
                    <span id="msg" class="ms-2"></span>
                </form>
            </div>
        </div>

        <!-- RIGHT: Appointment + Actions -->
        <div class="col-lg-3">
            <div class="info-card sticky-panel">
                <h6 class="section-title">ðŸ“… Appointment</h6>

                <p><b>Date:</b> {{ appointment.appointment_date|date:"F j, Y" }}</p>
                <p><b>Time:</b>
                    {{ appointment.start_time|time:"g:i A" }} â€”
                    {{ appointment.end_time|time:"g:i A" }}
                </p>
                <p>
                    <b>Status:</b>
                    <span class="badge bg-success">
                        {{ appointment.get_status_display }}
                    </span>
                </p>

                <hr>
                <h6 class="section-title">âš¡ Quick Actions</h6>

               

                <!-- PRINT / PDF -->
                <a href="{% url 'report_preview' appointment.id %}"
                   target="_blank"
                   class="btn btn-outline-secondary w-100">
                    Print Prescription
                </a>

            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById("notesForm").addEventListener("submit", function(e){
    e.preventDefault();

    fetch("{% url 'save_notes' appointment.id %}", {
        method: "POST",
        body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("msg").innerHTML =
            `<span class="text-success fw-semibold">${data.message}</span>`;
    })
    .catch(() => {
        document.getElementById("msg").innerHTML =
            `<span class="text-danger">Save failed</span>`;
    });
});
</script>
{% endblock %}
